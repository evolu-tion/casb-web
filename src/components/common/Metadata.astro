---
import merge from 'lodash.merge';

import { SITE, METADATA } from '~/utils/config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';
import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title = '',
  description = '',
  canonical = String(getCanonical(String(Astro.url.pathname))),
  openGraph = {},
  twitter = {},
  robots = {},
} = Astro.props as Props;

const noindex = robots?.index === false;
const nofollow = robots?.follow === false;

const defaults = {
  title: METADATA?.title?.default ?? SITE?.name ?? '',
  titleTemplate: METADATA?.title?.template ?? '%s',
  canonical,
  description: (METADATA as any)?.description ?? '',
  openGraph: {
    type: 'website',
    images: [],
  },
  twitter: {},
  // derived from robots
  noindex,
  nofollow,
};

const seoProps = merge({}, defaults, {
  title,
  description,
  openGraph,
  twitter,
  noindex,
  nofollow,
});

// adaptOpenGraphImages returns an adapted openGraph object; merge it into the final meta
const adaptedOpenGraph = await adaptOpenGraphImages(seoProps.openGraph, Astro.site);
const final = merge({}, seoProps, { openGraph: adaptedOpenGraph });
---

<title>{final?.title ?? seoProps.title ?? ''}</title>
{final?.canonical && <link rel="canonical" href={final.canonical} />}
{final?.description && <meta name="description" content={final.description} />}
{(final?.noindex || seoProps.noindex) && <meta name="robots" content="noindex" />}
{(final?.nofollow || seoProps.nofollow) && <meta name="robots" content="nofollow" />}

{/* Open Graph */}
{
  final?.openGraph && (
    <>
      <meta property="og:title" content={final.openGraph?.url ?? final.title ?? seoProps.title ?? ''} />
      <meta property="og:description" content={final.description ?? seoProps.description ?? ''} />
      <meta property="og:url" content={final.canonical ?? seoProps.canonical ?? ''} />
      {final.openGraph?.siteName && <meta property="og:site_name" content={final.openGraph.siteName} />}
      {final.openGraph?.type && <meta property="og:type" content={final.openGraph.type} />}
      {final.openGraph?.images &&
        final.openGraph.images.map((img: any) => (img?.url ? <meta property="og:image" content={img.url} /> : null))}
    </>
  )
}

{/* Twitter */}
{
  (final?.twitter || seoProps.twitter) && (
    <>
      <meta name="twitter:card" content={final.twitter?.cardType ?? seoProps.twitter?.cardType ?? 'summary'} />
      {(final.twitter?.handle ?? seoProps.twitter?.handle) ? (
        <meta name="twitter:creator" content={final.twitter?.handle ?? seoProps.twitter?.handle} />
      ) : null}
    </>
  )
}
